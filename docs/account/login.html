<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="../css/tailwind-output.css">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

    <!-- 引入SweetAlert2相關的CSS和JavaScript檔案 -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11.0.18/dist/sweetalert2.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.0.18/dist/sweetalert2.min.js"></script>

    <title>登入</title>
</head>

<body>
    <div id="app">
        <!-- NavBar -->
        <nav_component
            v-on:emit-home="homeClick"
            v-on:emit-login="switchLoginClick"
            v-on:emit-register="switchRegisterClick"
        >
        </nav_component>
        <!-- Content -->
        <div class="bg-gray-100 flex flex-col items-center justify-center min-h-screen">
            <div class="bg-white shadow-md rounded px-8 pt-6 pb-8 mb-4 flex flex-col border-2">
                <div class="-mx-3 md:flex">
                    <div class="md:w-full px-3">
                        <label class="block uppercase tracking-wide text-gray-700 text-xs font-bold mb-2"
                            for="userNumber">
                            帳號
                        </label>
                        <input
                            class="appearance-none block w-full bg-gray-200 text-gray-700 border border-gray-200 rounded py-3 px-4 mb-3 leading-tight focus:outline-none focus:bg-white focus:border-gray-500"
                            id="username" type="text" placeholder="Enter your username" v-model="account">
                    </div>
                </div>
                <div class="-mx-3 md:flex mb-6">
                    <div class="md:w-full px-3">
                        <label class="block uppercase tracking-wide text-gray-700 text-xs font-bold mb-2"
                            for="password">
                            密碼
                        </label>
                        <input
                            class="appearance-none block w-full bg-gray-200 text-gray-700 border border-gray-200 rounded py-3 px-4 mb-3 leading-tight focus:outline-none focus:bg-white focus:border-gray-500"
                            id="password" type="password" placeholder="Enter your password" v-model="password">
                    </div>
                </div>
                <button
                    class="bg-green400 hover:bg-blue-700  font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline"
                    type="button" @click.prevent="loginClick">
                    登入
                </button>
                <div class="flex justify-center items-center mt-4">
                    <a class="inline-block align-baseline font-bold text-sm text-blue-500 hover:text-blue-800" href="#"
                        @click.prevent="switchForgetPasswordClick">
                        忘記密碼?
                    </a>
                </div>
                <hr>
                <button
                    class="bg-navbar hover:bg-blue-700 mt-4 font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline"
                    type="button" @click.prevent="switchRegisterClick">
                    註冊
                </button>
            </div>
        </div>
    </div>
    <script src="https://code.jquery.com/jquery-3.6.4.js"></script>
    <!-- 載入 Vue Core -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/vue/3.2.37/vue.global.js"></script>
    <!-- 載入 VeeValidate -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/vee-validate/4.5.8/vee-validate.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@vee-validate/rules@4.5.8/dist/vee-validate-rules.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@vee-validate/i18n@4.5.8/dist/vee-validate-i18n.min.js"></script>
    <!-- axios -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.21.1/axios.min.js"></script>
    <!-- Vue 起手式 -->
    <script type="module">
        // 公用程式 utilities
        import utilities from '../js/utilities.js';

        // API Config
        import config from '../js/config.js';
        const loginAPI = config.loginAPI;

        // Nav Component
        import nav_component from '../js/component_nav.js';

        const app = Vue.createApp({
            data() {
                return {
                    account: '',
                    password: ''
                };
            },
            methods: {
                loginClick() {
                    console.log('loginClick() ...');

                    // Todo : 檢查 輸入資訊


                    const requestBody = {
                        "email": this.account,
                        "password": this.password
                    };

                    console.log(`loginAPI => ${loginAPI}`);
                    console.log(requestBody);

                    // 顯示 processing dialog
                    Swal.fire({
                        title: 'Processing...',
                        allowOutsideClick: false,
                        onBeforeOpen: () => {
                            Swal.showLoading();
                        },
                    });

                    axios.post(loginAPI, requestBody)
                        .then((res) => {
                            // 登入 成功
                            console.log('login 成功');
                            console.log(res);
                            // 記錄 JWT 進入 local storage 
                            utilities.setJwtToken(res.data.token);
                            // 顯示 登入成功 Dialog
                            Swal.fire({
                                title: 'Success!',
                                text: 'You have logged in successfully.',
                                icon: 'success',
                                showCancelButton: false,
                                confirmButtonText: 'OK',
                            }).then((result) => {
                                // 轉頁面到首頁                            
                                if (result.isConfirmed) {
                                    window.location.href = '../index.html'
                                }
                            });

                        }).catch((err) => {
                            // 登入 失敗
                            console.log('login 失敗');
                            console.log(err);
                            console.log(err.response);
                            // 顯示錯誤訊息
                            Swal.fire({
                                title: 'Error!',
                                text: 'Failed to login. Please check your email and password.',
                                allowOutsideClick: false,
                                icon: 'error',
                            });
                        })
                        .finally(() => {
                            Swal.hideLoading();
                        });


                },
                // 點擊 Ticktock 回首頁 功能
                homeClick() {
                    console.log('homeClick() ...');
                    window.location.replace('../index.html');
                },
                // 點擊 搜尋按鈕
                searchClick() {
                    console.log('searchClick() ...');
                    // todo: 搜尋功能 ...
                },
                // 切換到 登入頁面
                switchLoginClick() {
                    console.log('switchLoginClick() ...');
                    window.location.replace('login.html');
                },
                // 切換到 註冊頁面
                switchRegisterClick() {
                    console.log('switchRegisterClick() ...');
                    window.location.replace('register.html');
                },
                // 切換到 忘記密碼頁面
                switchForgetPasswordClick() {
                    console.log('switchForgetPasswordClick() ...');
                    window.location.replace('password.html');
                },
                // 預設 測試資料
                initTestData() {
                    // this.account = 'linchinan12@gmail.com';
                    // this.password = '1qaz2wsx';
                }
            },
            // 生命週期 -- Mounted
            mounted() {
                this.initTestData();
            }
        });
        // 綁定 VeeValidate 進入 全域物件
        app.component('VForm', VeeValidate.Form);
        app.component('VField', VeeValidate.Field);
        app.component('ErrorMessage', VeeValidate.ErrorMessage);
        // 設定 Nav Component
        app.component('nav_component', nav_component);
        // 將 Vue 綁定到 <div id="app"> 上面
        app.mount('#app');

    </script>
</body>

</html>